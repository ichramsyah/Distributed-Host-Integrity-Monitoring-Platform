name: Deploy to Paramadina Server (Final)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    name: DevSecOps Pipeline
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Security Scan (Trivy)
        run: |
          trivy fs . \
            --severity CRITICAL,HIGH \
            --format table \
            --ignore-unfixed \
            --exit-code 1

      - name: Deployment (Ansible)
        if: success()
        run: |
          echo "âœ… Security Check Lolos! Deploying..."
          cd /home/webadm1/fim_infra
          # Memastikan permission aman sebelum deployment
          ansible-playbook -i inventory.ini deploy_backend.yml
          echo "ðŸŽ‰ Deployment Selesai!!"
